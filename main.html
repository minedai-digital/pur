<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>نظام إدارة المشتريات - الصفحة الرئيسية</title>
  <meta name="description" content="نظام إدارة المشتريات والتوريدات - النموذج الرئيسي">
  <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@700&family=Lateef&family=Cairo:wght@400;700&display=swap" rel="stylesheet">

  <style>
    body {font-family:'Cairo','Lateef',Arial,sans-serif; background:#f8fafb;}
    nav.navbar {background:#156ab2; color:#fff;padding:7px 0 0 0;border-radius:0 0 18px 18px;box-shadow:0 6px 24px #94d9fd26;}
    .nav-container{display:flex;align-items:center;justify-content:space-between;max-width:1200px;margin:auto;}
    .nav-logo{font-size:1.21rem;padding:8px 24px;letter-spacing:1px;font-family:'Amiri',serif}
    .nav-links{display:flex;gap:7px;margin:0;padding:0;list-style:none}
    .nav-links li{display:inline-block;}
    .nav-links a{color:#fff;text-decoration:none;font-size:1rem;padding:9px 16px;border-radius:7px;transition:.13s;}
    .nav-links a:hover,.nav-links a.active{background:#3482ce;color:#fffd9b;}
    .nav-login{padding:0 20px;}
    .btn-login{background:#fcfbc3;padding:9px 18px;border:0;border-radius:7px;font-size:1rem;color:#3269b7;cursor:pointer;}
    .btn-login:hover{background:#fff19e}
    .nav-toggle{display:none;}
    @media(max-width:1100px){.nav-container{flex-wrap:wrap;}.nav-links{flex-wrap:wrap;}}
    @media(max-width:830px){.nav-links a{padding:9px 8px; font-size:0.95rem;}}
    @media(max-width:600px){
      .nav-links{flex-direction:column;align-items:flex-start;}
      .nav-links a{padding:9px 5px;}
      .nav-container{flex-direction:column;align-items:flex-start;}
      .nav-toggle{display:block;position:absolute;top:11px;left:15px;}
    }

    header.main-header {background: linear-gradient(135deg, #2196f3 0%, #1865be 100%); color: white; padding: 2rem 1rem; text-align: center; box-shadow: 0 7px 24px #6ddcff40; margin-bottom: 2rem; border-radius: 0 0 25px 25px;}
    header.main-header h1{font-family:'Amiri',serif;font-size:2.2rem;letter-spacing:1px;}
    .main-header .entity-bar{font-family:'Lateef','Cairo';font-size:1.13rem;background:#e3f7f9;color:#215e87;margin:14px auto 0;padding:7px 12px;display:inline-block;border-radius:6px;}
    
    .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(210px,1fr));gap:1.1rem;margin-bottom:2rem;}
    .stat-card{background:white;padding:1.3rem 0.7rem;border-radius:15px;box-shadow:0 3px 12px #b0dee233;text-align:center;min-width:180px;}
    .stat-card h3{color:#2380bf;font-size:1.02rem;}
    .stat-card .stat-value{font-size:1.49rem;font-weight:bold;color:#166c81;}

    .stats-summary{display:flex;justify-content:center;gap:2.7rem;align-items:center;margin-bottom:1.4rem;}
    .stats-summary div{font-size:1.1rem;}
    
    .entity-config-section{margin-bottom:2.2rem;}
    .entity-config-title{font-family:'Amiri',serif;font-size:1.18rem;color:#2363b5;}
    .entity-inputs{display:flex;gap:1.1rem;flex-wrap:wrap;}
    .entity-inputs .enhanced-input{flex:1;}
    
    .form-section,.signatures-section,.controls-section{background:white;padding:2rem;border-radius:17px;box-shadow:0 3px 14px #b0e6ef33;margin-bottom:2rem;}
    h2.section-title{font-family:'Amiri',serif;font-size:1.22rem;color:#1769ae;margin-bottom:1.4rem;}
    .input-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:1.4rem;margin-bottom:2rem;}
    .enhanced-input{position:relative;}
    .enhanced-input input {width: 100%; padding: 0.75rem 1rem; border: 2px solid #1765ae; border-radius: 11px; font-size: 1rem; color:#0e375c;}
    .enhanced-input input:focus { border-color: #2196f3; box-shadow: 0 0 0 0.14rem #aae6e911;}
    .enhanced-input label{color:#165b62;font-weight:700;}
    .table-container{background:white;border-radius:16px;overflow:hidden;box-shadow:0 3px 14px #b1e4ea2a;margin-bottom:1.6rem;}
    .table-header{background:#2196f3;color:white;padding:1rem 1.5rem;font-weight:600;font-size:1.04rem;}
    .enhanced-table{width:100%;border-collapse:collapse;font-size:1.02rem;}
    .enhanced-table th{background:#2066be;color:#fff;padding:0.95rem 0.5rem;font-weight:600;text-align:center;}
    .enhanced-table td{padding:0.73rem;border:1px solid #bedff1;text-align:center;color:#174053;font-size:1.01rem;}
    .enhanced-table input[type="text"], .enhanced-table input[type="number"]{color:#174053!important;font-weight:600;background:#f5fdff;border-radius:8px;padding:5px 7px;font-size:1rem;}
    .enhanced-table tfoot td{background:#ecf7fe;font-weight:bold;}
    .action-buttons{display:flex;gap:0.5rem;justify-content:center;flex-wrap:wrap;}
    .btn{background:linear-gradient(90deg,#1ebea5 0%,#156ab2 100%);color:#fff;border:none;border-radius:10px;padding:0.5rem 1.2rem;font-size:1rem;margin-top:0.2rem;cursor:pointer;transition:.15s;}
    .btn:hover{background:linear-gradient(90deg,#2196f3 10%,#43d5a0 85%);}
    .signatures-section{margin-top:1.7rem;}
    .signatures-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(230px,1fr));gap:1.3rem;}
    .signature-card{background:#f5f9fc;padding:1.1rem;border-radius:12px;border:1px solid #d2eaf1;}
    .highlight-cell{background: #9afdcd!important;color:#084e27!important;}
    footer {margin:35px 0 15px; font-family:'Lateef','Cairo'; text-align:right; font-size:1.08rem; color:#144054;}
    .entity-footer {margin-top:18px;}
    @media (max-width:1150px){.entity-inputs{flex-direction:column;gap:0.7rem;}}
    @media (max-width:800px){header.main-header{padding:1.15rem;}
      .stats-grid,.input-grid,.signatures-grid{grid-template-columns:1fr;}
      .table-header{padding:0.7rem;}
      .entity-bar{font-size:0.99rem;}
    }
    @media print {
      body {background:white;}
      header.main-header,.navbar,.controls-section,.action-buttons,.btn,.entity-footer{display:none!important;}
      .table-header{background:#2196f3!important;}
      .form-section,.table-container,.signatures-section{box-shadow:none;border-radius:0;}
      .print-header,.print-stamp{display:block!important;}
      .signatures-section{margin:0;}
      .enhanced-table{font-size:1.04rem!important;}
    }
    /* تعطيل أسهم الأرقام في جميع المدخلات */
    input[type="number"],input[pattern="\d*"]{-webkit-appearance:none;-moz-appearance:textfield;appearance:textfield;}
    input::-webkit-inner-spin-button,input::-webkit-outer-spin-button{-webkit-appearance:none;margin:0;}
  </style>
</head>
<body>
  <!-- الشريط العلوي للقوائم -->
  <nav class="navbar">
    <div class="nav-container">
      <div class="nav-logo"><span>🏥</span> نظام إدارة المشتريات</div>
      <ul class="nav-links">
        <li><a href="main.html" class="active">📋 النموذج الرئيسي</a></li>
        <li><a href="taw.html">📦 أمر التوريد</a></li>
        <li><a href="taf.html">💰 تفريغ الأسعار</a></li>
        <li><a href="mahdr.html">📝 المحضر</a></li>
        <li><a href="talab.html">📄 طلب الشراء</a></li>
        <li><a href="moka.html">📈 المقايسة</a></li>
        <li><a href="tash.html">👥 تشكيل لجنة</a></li>
        <li><a href="custom.html">📊 الضرائب</a></li>
      </ul>
      <div class="nav-login">
        <button class="btn-login" onclick="if(confirm('هل أنت متأكد من تسجيل الخروج؟')) window.location.href='index.html'" title="تسجيل الخروج">
          <span>🚪</span> تسجيل الخروج
        </button>
      </div>
      <div class="nav-toggle" onclick="toggleMenu()"><span>☰</span></div>
    </div>
  </nav>

  <header class="main-header">
    <h1 id="entityNameHeader">نظام إدارة المشتريات والتوريدات</h1>
    <div class="entity-bar" id="entityDeptHeader"></div>
    <p>النموذج الرئيسي لإدخال بيانات الأصناف والموردين</p>
    <div class="progress-indicator"><div class="progress-bar"></div></div>
  </header>

  <!-- إحصائيات/إجماليات حية أعلى الجدول كما طلبت -->
  <div class="stats-summary" dir="rtl">
    <div style="color:#115b99;border-bottom:2.5px solid #2196f3;padding-bottom:2.5px;">عدد العناصر المدخلة: <span id="countItems" style="font-weight:bold;">0</span></div>
    <div style="color:#0e8037;">إجمالي المورد الأول: <span id="supplierTotal1" style="font-weight:bold;">0.00</span> ج.م</div>
    <div style="color:#8d710c;">إجمالي المورد الثاني: <span id="supplierTotal2" style="font-weight:bold;">0.00</span> ج.م</div>
    <div style="color:#c02f34;">إجمالي المورد الثالث: <span id="supplierTotal3" style="font-weight:bold;">0.00</span> ج.م</div>
  </div>

  <div class="container main-form">
    <!-- لوحة الإحصائيات -->
    <div class="stats-grid">
      <div class="stat-card"><h3>إجمالي الأصناف</h3><div class="stat-value">0</div></div>
      <div class="stat-card"><h3>الصفوف المكتملة</h3><div class="stat-value">0</div></div>
      <div class="stat-card"><h3>إجمالي القيمة</h3><div class="stat-value">0.00 ج.م</div></div>
    </div>

    <!-- إعدادات الجهة -->
    <div class="entity-config-section">
      <h3 class="entity-config-title"><span>🏥</span> إعدادات الجهة</h3>
      <div class="entity-inputs">
        <div class="enhanced-input">
          <label class="form-label">اسم الجهة:</label>
          <input type="text" id="entityName" class="form-control" placeholder="اسم الجهة">
        </div>
        <div class="enhanced-input">
          <label class="form-label">القسم:</label>
          <input type="text" id="entityDepartment" class="form-control" placeholder="اسم القسم">
        </div>
      </div>
    </div>

    <!-- نموذج البيانات الأساسية كما هو -->
    <div class="form-section">
      <h2 class="section-title">📋 البيانات الأساسية</h2>
      <div class="input-grid">
        <div class="enhanced-input">
          <label class="form-label">📅 التاريخ:</label>
          <input type="date" id="date" class="form-control" required>
        </div>
        <div class="enhanced-input">
          <label class="form-label">المورد الأول:</label>
          <input list="suppliersList" id="supplier1" class="form-control" placeholder="اختر المورد الأول" oninput="mainFormManager?.updateSupplierHeaders()">
        </div>
        <div class="enhanced-input">
          <label class="form-label">المورد الثاني:</label>
          <input list="suppliersList" id="supplier2" class="form-control" placeholder="اختر المورد الثاني" oninput="mainFormManager?.updateSupplierHeaders()">
        </div>
        <div class="enhanced-input">
          <label class="form-label">المورد الثالث:</label>
          <input list="suppliersList" id="supplier3" class="form-control" placeholder="اختر المورد الثالث" oninput="mainFormManager?.updateSupplierHeaders()">
        </div>
        <div class="enhanced-input">
          <label class="form-label">تاريخ اللجنة:</label>
          <input type="date" id="committeeDate" class="form-control" required>
        </div>
        <div class="enhanced-input">
          <label class="form-label">نسبة الضريبة %:</label>
          <input type="number" id="taxRate" class="form-control" value="14" min="0" max="100" step="0.01">
        </div>
      </div>
    </div>

    <!-- الجدول والتجميع والتمييز -->
    <div class="table-container">
      <div class="table-header">
        <span>📊 جدول الأصناف والأسعار</span>
        <div class="action-buttons" style="float:left;">
          <button class="btn" onclick="addRow()" title="إضافة صف جديد"><span>➕</span> إضافة صف</button>
          <button class="btn" onclick="clearTable()" title="مسح جميع البيانات"><span>🗑️</span> مسح الكل</button>
        </div>
        <div style="clear:both;"></div>
      </div>
      <table class="enhanced-table" id="itemsTable">
        <thead>
          <tr>
            <th>م</th>
            <th>اسم الصنف</th>
            <th>الوحدة</th>
            <th>الكمية</th>
            <th id="th-supplier1">سعر المورد الأول</th>
            <th id="th-supplier2">سعر المورد الثاني</th>
            <th id="th-supplier3">سعر المورد الثالث</th>
            <th>ملاحظات</th>
            <th>إجراءات</th>
          </tr>
        </thead>
        
          <tbody id="itemsTableBody"></tbody>

        
        <tfoot>
          <tr>
            <td colspan="4"><b>الإجمالي</b></td>
            <td id="total1" class="highlight-cell">0.00</td>
            <td id="total2" class="highlight-cell">0.00</td>
            <td id="total3" class="highlight-cell">0.00</td>
            <td colspan="2"></td>
          </tr>
        </tfoot>
      </table>
    </div>

    <div class="signatures-section">
      <h3 class="section-title">✍️ التوقيعات والاعتمادات</h3>
      <div id="signaturesList" class="signatures-grid"></div>
    </div>

    <div class="controls-section">
      <h3 class="section-title">🛠️ أدوات التحكم</h3>
      <div class="action-buttons">
        <button class="btn" onclick="addRow()">➕ إضافة صف</button>
        <button class="btn" onclick="mainFormManager?.saveData?.()">💾 حفظ البيانات</button>
        <button class="btn" onclick="mainFormManager?.loadData?.()">📁 تحميل البيانات</button>
        <button class="btn" onclick="saveAndGo()" title="حفظ والانتقال"><span>💾</span> حفظ وانتقال</button>
        <button class="btn" onclick="clearTable()">🗑️ مسح الكل</button>
        <button class="btn" onclick="window.print()">🖨️ طباعة</button>
      </div>
    </div>
    <footer class="entity-footer" id="signaturesFooter"></footer>
  </div>

  <datalist id="suppliersList"></datalist>
  <datalist id="itemsList"></datalist>
  <datalist id="staffList"></datalist>

  <script src="js/data.js"></script>
  <script src="js/utils.js"></script>
  <script src="js/main.js"></script>
  <script>
    // جلب اسم الجهة والقسم من صفحة الإعدادات وعرضها في رأس الصفحة 
    document.addEventListener('DOMContentLoaded',function(){
      let entityName = localStorage.getItem('hospitalName') || '';
      let entityDept = localStorage.getItem('departmentName') || '';
      document.getElementById('entityNameHeader').innerText = entityName || 'نظام إدارة المشتريات والتوريدات';
      document.getElementById('entityDeptHeader').innerText = entityDept || '';
      document.getElementById('entityName').value = entityName;
      document.getElementById('entityDepartment').value = entityDept;
      // عرض التوقيعات
      let sigs = [];
      try { sigs = JSON.parse(localStorage.getItem('signaturesArray')) || []; } catch{}
      if (sigs.length) {
        let html = sigs.map(sig => `<div class="signature-card">${sig.name}<br><small style="color:#29709f">${sig.desc}</small></div>`).join("");
        document.getElementById('signaturesList').innerHTML = html;
        document.getElementById('signaturesFooter').innerHTML = 
          sigs.map(sig => `<b>${sig.name}</b> ـ <span style="color:#2579a2">${sig.desc}</span>`).join("، ");
      }
      updateTotalsLive();
    });
    document.getElementById('entityName').addEventListener('input',function(e){
      localStorage.setItem('hospitalName',e.target.value);
      document.getElementById('entityNameHeader').innerText = e.target.value;
    });
    document.getElementById('entityDepartment').addEventListener('input',function(e){
      localStorage.setItem('departmentName',e.target.value);
      document.getElementById('entityDeptHeader').innerText = e.target.value;
    });

    // تحديث الإجماليات أعلى الجدول وتمييز الأقل
    function updateTotalsLive() {
      const tbody = document.querySelector('#itemsTable tbody');
      let total = [0,0,0];
      let count = 0;
      [...tbody.rows].forEach(tr => {
        let qty = parseFloat(tr.cells[3].querySelector('input').value) || 0;
        if (qty>0) count++;
        for(let i=0;i<3;i++){
          let price = parseFloat(tr.cells[4+i].querySelector('input').value) || 0;
          total[i] += qty*price;
        }
      });
      document.getElementById('countItems').textContent = count;
      document.getElementById('supplierTotal1').textContent = total[0].toFixed(2);
      document.getElementById('supplierTotal2').textContent = total[1].toFixed(2);
      document.getElementById('supplierTotal3').textContent = total[2].toFixed(2);

      // تمييز المورد الأقل في tfoot & أعلى الصفحة
      let minVal = Math.min(...total.filter(x=>x>0));
      for(let i=0;i<3;i++){
        let td = document.getElementById('total'+(i+1));
        let st = document.getElementById('supplierTotal'+(i+1));
        td.classList.remove('highlight-cell');
        st.parentNode.classList.remove('highlight-cell');
        if(minVal === total[i] && minVal>0){
          td.classList.add('highlight-cell');
          st.parentNode.classList.add('highlight-cell');
        }
      }
    }
    // حدث القيم عند تغيير أي مدخل رقمي بـtable فقط
    document.addEventListener('input', function(e){
      if(
        e.target.matches('.enhanced-table input[type="text"], .enhanced-table input[type="number"]')
        || e.target.closest('.enhanced-table')
      ){
        updateTotalsLive();
      }
    });
    setTimeout(updateTotalsLive, 200); // تحديث أولي بعد التحميل
    // زر القائمة الجانبية
    function toggleMenu(){document.querySelector('.nav-links').classList.toggle('active');}


function createRow(num, item='', unit='', qty=1, price1=0, price2=0, price3=0, notes=''){
  return `<tr>
    <td>${num}</td>
    <td><input list="itemsList" value="${item}" placeholder="اختر صنف"></td>
<td><input value="${unit}" placeholder="الوحدة"></td>
    <td><input type="number" value="${qty}" min="0" step="any" style="width:80px;"></td>
    <td><input type="number" value="${price1}" min="0" step="any" style="width:85px;"></td>
    <td><input type="number" value="${price2}" min="0" step="any" style="width:85px;"></td>
    <td><input type="number" value="${price3}" min="0" step="any" style="width:85px;"></td>
    <td><input value="${notes}" placeholder="ملاحظات"></td>
    <td><button onclick="this.closest('tr').remove(); updateTotalsLive();" class="btn">مسح</button></td>
  </tr>`;
}

// مثال إضافة 3 صفوف افتراضية عند التحميل
document.addEventListener('DOMContentLoaded',()=>{
  let tbody = document.getElementById('itemsTableBody');
  tbody.innerHTML = '';
  for(let i=0;i<3;i++){ tbody.innerHTML += createRow(i+1); }
  updateTotalsLive();
});

// عند الإضافة أو الحذف أو التعديل
document.addEventListener('input', function(e){
  if( e.target.closest('#itemsTable') ){
    updateTotalsLive();
  }
});
function addRow(){
  let tbody = document.getElementById('itemsTableBody');
  let n = tbody.rows.length+1;
  tbody.innerHTML += createRow(n);
  updateTotalsLive();
}

function updateTotalsLive(){
  let tbody = document.getElementById('itemsTableBody');
  let total=[0,0,0], count=0;
  [...tbody.rows].forEach((tr,idx)=>{
    tr.cells[0].textContent = idx+1;
    let qty = parseFloat(tr.cells[3].querySelector('input').value) || 0;
    if(qty>0) count++;
    for(let i=0;i<3;i++){
      let price = parseFloat(tr.cells[4+i].querySelector('input').value) || 0;
      total[i] += qty*price;
    }
  });
  document.getElementById('countItems').textContent=count;
  document.getElementById('supplierTotal1').textContent=total[0].toFixed(2);
  document.getElementById('supplierTotal2').textContent=total[1].toFixed(2);
  document.getElementById('supplierTotal3').textContent=total[2].toFixed(2);

  // لون الأقل
  let minVal = Math.min(...total.filter(x=>x>0));
  for(let i=0;i<3;i++){
    let td = document.getElementById('total'+(i+1));
    let st = document.getElementById('supplierTotal'+(i+1));
    td.classList.remove('highlight-cell'); st.parentNode.classList.remove('highlight-cell');
    if(minVal === total[i] && minVal>0){
      td.classList.add('highlight-cell'); st.parentNode.classList.add('highlight-cell');
    }
    td.textContent = total[i].toFixed(2);
  }
}


function saveAndGo() {
  // جمع كل بيانات الصفحة
  const data = {
    // إعدادات الجهة
    entityName: document.getElementById('entityName').value,
    entityDepartment: document.getElementById('entityDepartment').value,
    // بيانات أساسية
    date: document.getElementById('date').value,
    supplier1: document.getElementById('supplier1').value,
    supplier2: document.getElementById('supplier2').value,
    supplier3: document.getElementById('supplier3').value,
    committeeDate: document.getElementById('committeeDate').value,
    taxRate: document.getElementById('taxRate').value,
    // البيانات من صفوف الجدول
    table: Array.from(document.querySelectorAll('#itemsTable tbody tr')).map(tr => ({
      name: tr.cells[1].querySelector('input').value,
      unit: tr.cells[2].querySelector('input').value,
      qty: tr.cells[3].querySelector('input').value,
      price1: tr.cells[4].querySelector('input').value,
      price2: tr.cells[5].querySelector('input').value,
      price3: tr.cells[6].querySelector('input').value,
      notes: tr.cells[7].querySelector('input').value
    })),
    // التوقيعات/الاعتمادات من الصفحة إذا كانت هناك
    signatures: Array.from(document.querySelectorAll('.signatures-section .signature-card')).map(div => div.textContent.trim())
  };
  // حفظ كل البيانات في LocalStorage باسم ثابت
  localStorage.setItem("mainFormData", JSON.stringify(data));
  // الانتقال مثلا لصفحة taw.html أو غيرها (عدّل حسب اسم الصفحة المطلوبة)
  window.location.href = "taw.html";
}









  </script>
</body>
</html>
