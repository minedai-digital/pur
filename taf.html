<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>تفريغ الأسعار - taf</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600&display=swap" rel="stylesheet">
<style>
  body { font-family: 'Cairo', sans-serif; margin:0; background:#f0f2f5; color:#333; }
  header { background:#007bff; color:#fff; padding:15px; text-align:center; font-size:22px; font-weight:bold; box-shadow:0 2px 6px rgba(0,0,0,0.15); }
  .container { max-width:1400px; margin:20px auto; background:#fff; padding:20px; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); }
  h1.title { text-align:center; font-size:28px; margin-bottom:20px; font-weight:bold; }
  table { width:100%; border-collapse:collapse; margin-top:20px; background:#fff; border-radius:8px; overflow:hidden; box-shadow:0 2px 6px rgba(0,0,0,0.1); }
  th, td { border:1px solid #e5e5e5; padding:8px; text-align:center; font-size:14px; }
  th { background:#f8f9fa; font-weight:600; }
  tfoot td { font-weight:bold; background:#f1f3f5; }
  .highlight { background-color:#d4edda !important; }
  .footer-inputs, .top-inputs { display:grid; grid-template-columns:repeat(auto-fill,minmax(200px,1fr)); gap:15px; margin-top:20px; }
  .footer-inputs label, .top-inputs label { display:flex; flex-direction:column; font-weight:600; }
  input { padding:7px; border:1px solid #ccc; border-radius:6px; margin-top:5px; }
  button { padding:10px 18px; border:none; border-radius:6px; margin:5px; cursor:pointer; font-size:14px; font-weight:bold; transition:0.2s; }
  button:hover { opacity:0.85; }
  .print { background:#28a745; color:#fff; }
  .add { background:#007bff; color:#fff; }
  .clear { background:#dc3545; color:#fff; }
  @media(max-width:1024px){table, th, td{font-size:12px;}}
  @media(max-width:768px){.footer-inputs, .top-inputs{grid-template-columns:1fr;}}
</style>
</head>



<!-- ضع هذا الكود أسفل وسم <body> مباشرة قبل <header> -->
<nav class="navbar">
  <div class="nav-container">
    <div class="nav-logo"> تطبيق المشتريات</div>
    <ul class="nav-links">
      <li><a href="main.html">الرئيسية</a></li>
      <li><a href="taw.html">التوريد</a></li>
      <li><a href="taf.html">تفريغ</a></li>
      <li><a href="mahdr.html">محضر</a></li>
      <li><a href="talab.html">طلب</a></li>
      <li><a href="moka.html">مقايسه</a></li>
      <li><a href="tash.html">تشكيل</a></li>
      <li><a href="custom.html">الضرايب</a></li>
    </ul>
    <div class="nav-toggle" onclick="toggleMenu()">☰</div>
  </div>
</nav>

<style>
/* Navbar أساسي */
.navbar {
  background-color: #007bff;
  color: #fff;
  font-family: 'Cairo', sans-serif;
  position: sticky;
  top: 0;
  z-index: 1000;
  box-shadow: 0 2px 6px rgba(0,0,0,0.15);
}

.nav-container {
  max-width: 1200px;
  margin: auto;
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px 20px;
}

.nav-logo {
  font-size: 20px;
  font-weight: bold;
}

.nav-links {
  list-style: none;
  display: flex;
  gap: 15px;
  margin: 0;
  padding: 0;
}

.nav-links li a {
  color: #fff;
  text-decoration: none;
  font-weight: 600;
  padding: 8px 12px;
  border-radius: 6px;
  transition: background 0.2s;
}

.nav-links li a:hover {
  background-color: rgba(255,255,255,0.2);
}

.nav-toggle {
  display: none;
  font-size: 24px;
  cursor: pointer;
}

/* تصميم متجاوب */
@media (max-width: 768px) {
  .nav-links {
    display: none;
    flex-direction: column;
    gap: 10px;
    background-color: #007bff;
    padding: 10px 0;
  }
  .nav-links.active {
    display: flex;
  }
  .nav-toggle {
    display: block;
  }
}
</style>

<script>
function toggleMenu() {
  document.querySelector('.nav-links').classList.toggle('active');
}
</script>








<body>

<header>الإدارة الصحية</header>

<div class="container">
  <h1 class="title">تفريغ الأسعار</h1>

  <div class="top-inputs">
    <label>تاريخ: <input type="date" id="orderDate"></label>
  </div>

  <div style="text-align:center; margin-bottom:10px;">
    <button class="add" onclick="addEmptyRow()">➕ إضافة صف</button>
    <button class="clear" onclick="clearTable()">🗑️ مسح الكل</button>
    <button class="print" onclick="window.print()">🖨️ طباعة</button>
  </div>

  <table id="itemsTable">
  <thead>
    <tr>
      <th>م</th>
      <th>الصنف</th>
      <th>الوحدة</th>
      <th>الكمية</th>
      <th id="th-supplier1">المورد الأول</th>
      <th>بعد الضريبة</th>
      <th id="th-supplier2">المورد الثاني</th>
      <th>بعد الضريبة</th>
      <th id="th-supplier3">المورد الثالث</th>
      <th>بعد الضريبة</th>
    </tr>
  </thead>
  <tbody></tbody>
  <tfoot>
    <tr>
      <td colspan="4">الإجمالي</td>
      <td id="total1">0</td>
      <td id="total1After">0</td>
      <td id="total2">0</td>
      <td id="total2After">0</td>
      <td id="total3">0</td>
      <td id="total3After">0</td>
    </tr>
  </tfoot>
</table>


  <div class="footer-inputs">
    <label>المختص: <input type="text" id="officer"></label>
    <label>رئيس القسم: <input type="text" id="head"></label>
    <label>يعتمد: <input type="text" id="approved"></label>
    <label>اسم اللجنة الأول: <input type="text" id="committee1"></label>
    <label>اسم اللجنة الثاني: <input type="text" id="committee2"></label>
    <label>اسم اللجنة الثالث: <input type="text" id="committee3"></label>
  </div>
</div>

<script src="data.js"></script>
<script>
let rowCount=0;

// إضافة صف جديد فارغ
function addEmptyRow(){
  rowCount++;
  const tbody=document.querySelector('#itemsTable tbody');
  const tr=document.createElement('tr');
  tr.innerHTML=`
    <td>${rowCount}</td>
    <td><input list="itemsList"></td>
    <td><input type="text"></td>
    <td><input type="number" value="0" oninput="updateRow(this)"></td>
    <td><input type="number" value="0" oninput="updateRow(this)"></td>
    <td>0</td>
    <td><input type="number" value="0" oninput="updateRow(this)"></td>
    <td>0</td>
    <td><input type="number" value="0" oninput="updateRow(this)"></td>
    <td>0</td>
    
    <td><button onclick="removeRow(this)">مسح</button></td>
  `;
  tbody.appendChild(tr);
  updateTotals();
}

// إزالة صف
function removeRow(btn){ btn.closest('tr').remove(); updateTotals(); }

// مسح الجدول بالكامل
function clearTable(){
  document.querySelector('#itemsTable tbody').innerHTML='';
  rowCount=0;
  updateTotals();
}

function updateRow(input, taxRate=0.15){
  const tr = input.closest('tr');
  const qty = parseFloat(tr.cells[3].querySelector('input').value) || 0;
  const price1 = parseFloat(tr.cells[4].querySelector('input').value) || 0;
  const price2 = parseFloat(tr.cells[6].querySelector('input').value) || 0;
  const price3 = parseFloat(tr.cells[8].querySelector('input').value) || 0;

  const after1 = (price1*(1 + taxRate)).toFixed(2);
  const after2 = (price2*(1 + taxRate)).toFixed(2);
  const after3 = (price3*(1 + taxRate)).toFixed(2);

  tr.cells[5].textContent = after1;
  tr.cells[7].textContent = after2;
  tr.cells[9].textContent = after3;

  updateTotals(taxRate);
}

function updateTotals(taxRate=0.15){
  let totals = [0,0,0,0,0,0]; // price1, after1, price2, after2, price3, after3

  document.querySelectorAll('#itemsTable tbody tr').forEach(tr=>{
    totals[0] += parseFloat(tr.cells[4].querySelector('input').value) || 0;
    totals[1] += parseFloat(tr.cells[5].textContent) || 0;
    totals[2] += parseFloat(tr.cells[6].querySelector('input').value) || 0;
    totals[3] += parseFloat(tr.cells[7].textContent) || 0;
    totals[4] += parseFloat(tr.cells[8].querySelector('input').value) || 0;
    totals[5] += parseFloat(tr.cells[9].textContent) || 0;
  });

  document.getElementById('total1').textContent = totals[0].toFixed(2);
  document.getElementById('total1After').textContent = totals[1].toFixed(2);
  document.getElementById('total2').textContent = totals[2].toFixed(2);
  document.getElementById('total2After').textContent = totals[3].toFixed(2);
  document.getElementById('total3').textContent = totals[4].toFixed(2);
  document.getElementById('total3After').textContent = totals[5].toFixed(2);

highlightMinPrices();

}

// تمييز أقل سعر لكل مورد (السعر قبل الضريبة)
function highlightMinPrices() {
  // الأعمدة التي تحتوي على أسعار الموردين قبل الضريبة
  const cols = [4, 6, 8]; // فهرس الأعمدة 0-based: 5,7,9 في الـ HTML
  cols.forEach((colIdx, i) => {
    const tds = Array.from(document.querySelectorAll(`#itemsTable tbody tr td:nth-child(${colIdx+1})`));
    // جلب قيم الأسعار من input داخل td
    const values = tds.map(td => parseFloat(td.querySelector('input')?.value) || 0);
    const minVal = Math.min(...values);
    // إزالة أي تمييز سابق
    tds.forEach(td => td.classList.remove('highlight'));
    // تمييز الأقل
    tds.forEach((td, idx) => {
      if(values[idx] === minVal) td.classList.add('highlight');
    });
  });
}


// تعبئة البيانات من main
window.onload=function(){
  const savedData=localStorage.getItem('mainFormData');
  if(savedData){
    const data=JSON.parse(savedData);
    document.getElementById('orderDate').value=data.committeeDate||'';
    document.getElementById('officer').value=data.footer[0]||'';
    document.getElementById('head').value=data.footer[1]||'';
    document.getElementById('approved').value=data.footer[2]||'';
    document.getElementById('committee1').value=data.footer[3]||'';
    document.getElementById('committee2').value=data.footer[4]||'';
    document.getElementById('committee3').value=data.footer[5]||'';
    if(data.table) data.table.forEach(row=>{
      rowCount++;
      addRowFromMain(row);
    });
  }
};

// إضافة صف تلقائي من main
function addRowFromMain(row){
  const item=row[1]||'', unit=row[2]||'', qty=parseFloat(row[3]||0),
        price1=parseFloat(row[4]||0), price2=parseFloat(row[5]||0), price3=parseFloat(row[6]||0);
  const tbody=document.querySelector('#itemsTable tbody');
  const tr=document.createElement('tr');
  const tax=0.15;
  const after1=(price1*(1+tax)).toFixed(2);
  const after2=(price2*(1+tax)).toFixed(2);
  const after3=(price3*(1+tax)).toFixed(2);
  const totalBefore=((qty*price1)+(qty*price2)+(qty*price3)).toFixed(2);
  const totalAfter=((qty*after1)+(qty*after2)+(qty*after3)).toFixed(2);
  tr.innerHTML=`
    <td>${rowCount}</td>
    <td><input list="itemsList" value="${item}" readonly></td>
    <td><input type="text" value="${unit}" readonly></td>
    <td><input type="number" value="${qty}" readonly></td>
    <td><input type="number" value="${price1}" readonly></td>
    <td>${after1}</td>
    <td><input type="number" value="${price2}" readonly></td>
    <td>${after2}</td>
    <td><input type="number" value="${price3}" readonly></td>
    <td>${after3}</td>
    <td>${totalBefore}</td>
    <td>${totalAfter}</td>
    <td><button onclick="removeRow(this)">مسح</button></td>
  `;
  tbody.appendChild(tr);
  updateTotals();
}
</script>

</body>
</html>
