<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>أمر التوريد - taw</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600&display=swap" rel="stylesheet">
<style>
  body { 
    font-family: 'Cairo', sans-serif; 
    margin:0; 
    background:#f0f2f5; 
    color:#333; 
    line-height: 1.6;
  }
  
  header { 
    background:#007bff; 
    color:#fff; 
    padding:15px; 
    text-align:center; 
    font-size:22px; 
    font-weight:bold; 
    box-shadow:0 2px 6px rgba(0,0,0,0.15); 
  }
  
  .container { 
    max-width:1200px; 
    margin:20px auto; 
    background:#fff; 
    padding:20px; 
    border-radius:8px; 
    box-shadow:0 2px 10px rgba(0,0,0,0.1); 
  }
  
  h1.title { 
    text-align:center; 
    font-size:28px; 
    margin-bottom:20px; 
    font-weight:bold; 
    color:#007bff;
  }
  
  .supplier-info, .footer-inputs { 
    display:grid; 
    grid-template-columns:repeat(auto-fill,minmax(200px,1fr)); 
    gap:15px; 
    margin-bottom:20px; 
  }
  
  .supplier-info label, .footer-inputs label { 
    display:flex; 
    flex-direction:column; 
    font-weight:600; 
    font-size:14px; 
  }
  
  .supplier-info input, .footer-inputs input { 
    padding:8px; 
    border:1px solid #ccc; 
    border-radius:6px; 
    margin-top:5px; 
    transition: border-color 0.3s ease;
  }
  
  .supplier-info input:focus, .footer-inputs input:focus {
    outline: none;
    border-color: #007bff;
    box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
  }
  
  table { 
    width:100%; 
    border-collapse:collapse; 
    margin-top:20px; 
    background:#fff; 
    border-radius:8px; 
    overflow:hidden; 
    box-shadow:0 2px 6px rgba(0,0,0,0.1); 
  }
  
  th, td { 
    border:1px solid #e5e5e5; 
    padding:10px; 
    text-align:center; 
    font-size:14px; 
  }
  
  th { 
    background:#f8f9fa; 
    font-weight:600; 
  }
  
  tbody tr:hover {
    background-color: rgba(0, 123, 255, 0.05);
  }
  
  td input {
    width: 100%;
    padding: 6px;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    font-size: 13px;
    transition: border-color 0.3s ease;
  }
  
  td input:focus {
    outline: none;
    border-color: #007bff;
  }
  
  tfoot td { 
    font-weight:bold; 
    background:#f1f3f5; 
    font-size: 16px;
    color: #007bff;
  }
  
  button { 
    padding:10px 18px; 
    border:none; 
    border-radius:6px; 
    margin:5px; 
    cursor:pointer; 
    font-size:14px; 
    font-weight:bold; 
    transition:all 0.3s ease; 
  }
  
  button:hover { 
    opacity:0.9; 
    transform: translateY(-1px);
  }
  
  .add { background:#007bff; color:#fff; }
  .clear { background:#dc3545; color:#fff; }
  .save { background:#17a2b8; color:#fff; }
  .load { background:#6f42c1; color:#fff; }
  .print { background:#28a745; color:#fff; }
  
  /* Navbar Styles */
  .navbar {
    background-color: #007bff;
    color: #fff;
    font-family: 'Cairo', sans-serif;
    position: sticky;
    top: 0;
    z-index: 1000;
    box-shadow: 0 2px 6px rgba(0,0,0,0.15);
  }

  .nav-container {
    max-width: 1200px;
    margin: auto;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 20px;
  }

  .nav-logo {
    font-size: 20px;
    font-weight: bold;
  }

  .nav-links {
    list-style: none;
    display: flex;
    gap: 15px;
    margin: 0;
    padding: 0;
  }

  .nav-links li a {
    color: #fff;
    text-decoration: none;
    font-weight: 600;
    padding: 8px 12px;
    border-radius: 6px;
    transition: background 0.3s ease;
  }

  .nav-links li a:hover {
    background-color: rgba(255,255,255,0.2);
  }

  .nav-toggle {
    display: none;
    font-size: 24px;
    cursor: pointer;
  }
  
  /* Loading Animation */
  .loading {
    display: none;
    text-align: center;
    padding: 20px;
  }
  
  .spinner {
    width: 40px;
    height: 40px;
    border: 4px solid #f3f3f3;
    border-top: 4px solid #007bff;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 10px;
  }
  
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
  
  /* Alert Messages */
  .alert {
    padding: 12px 20px;
    margin: 15px 0;
    border-radius: 6px;
    font-weight: 600;
    display: none;
  }
  
  .alert-success {
    background-color: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
  }
  
  .alert-error {
    background-color: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
  }

  /* Print Styles */
  @media print {
    body {
      margin-top: 50px;
      background: white;
    }
    
    .navbar, button, .loading, .alert {
      display: none !important;
    }
    
    .container {
      margin: 0;
      padding: 20px;
      box-shadow: none;
    }
    
    #printLogo {
      display: block !important;
      position: fixed;
      top: 10px;
      left: 10px;
      width: 120px;
      height: auto;
    }
  }

  /* Responsive Design */
  @media (max-width: 768px) {
    .nav-links {
      display: none;
      flex-direction: column;
      gap: 10px;
      background-color: #007bff;
      padding: 10px 0;
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
    }
    
    .nav-links.active {
      display: flex;
    }
    
    .nav-toggle {
      display: block;
    }
    
    .container {
      margin: 10px;
      padding: 15px;
    }
    
    .supplier-info, .footer-inputs {
      grid-template-columns: 1fr;
    }
    
    table {
      font-size: 12px;
    }
    
    th, td {
      padding: 8px 4px;
    }
  }
</style>
</head>

<body>
<img src="images/logo.png" id="printLogo" alt="Logo" style="display:none; position:absolute; top:10px; left:10px; width:120px; height:auto;">

<!-- Navigation -->
<nav class="navbar">
  <div class="nav-container">
    <div class="nav-logo">تطبيق المشتريات</div>
    <ul class="nav-links">
      <li><a href="main.html">الرئيسية</a></li>
      <li><a href="taw.html">التوريد</a></li>
      <li><a href="taf.html">تفريغ</a></li>
      <li><a href="mahdr.html">محضر</a></li>
      <li><a href="talab.html">طلب</a></li>
      <li><a href="moka.html">مقايسه</a></li>
      <li><a href="tash.html">تشكيل</a></li>
      <li><a href="custom.html">الضرايب</a></li>
    </ul>
    <div class="nav-toggle" onclick="toggleMenu()">☰</div>
  </div>
</nav>

<header>الإدارة الصحية</header>

<!-- Alert Messages -->
<div id="alertSuccess" class="alert alert-success"></div>
<div id="alertError" class="alert alert-error"></div>

<!-- Loading Animation -->
<div id="loading" class="loading">
  <div class="spinner"></div>
  <p>جاري المعالجة...</p>
</div>

<div class="container">
  <h1 class="title">أمر التوريد</h1>

  <div class="supplier-info">
    <label>اسم المورد: <input list="suppliersList" id="supplierName" autocomplete="off"></label>
    <label>عنوان المورد: <input type="text" id="supplierAddress" autocomplete="off"></label>
    <label>رقم التليفون: <input type="text" id="supplierPhone" autocomplete="off"></label>
    <label>تاريخ: <input type="date" id="orderDate"></label>
    <label>رقم التسجيل الضريبي: <input type="text" id="taxId" autocomplete="off"></label>
  </div>

  <table id="itemsTable">
    <thead>
      <tr>
        <th>م</th>
        <th>الصنف</th>
        <th>الوحدة</th>
        <th>الكمية</th>
        <th>سعر الوحدة</th>
        <th>الإجمالي قبل الضريبة</th>
        <th>الضريبة</th>
        <th>الإجمالي بعد الضريبة</th>
        <th>ملاحظات</th>
        <th>إجراءات</th>
      </tr>
    </thead>
    <tbody></tbody>
    <tfoot>
      <tr>
        <td colspan="7">الإجمالي النهائي</td>
        <td id="grandTotal">0.00</td>
        <td colspan="2"></td>
      </tr>
    </tfoot>
  </table>

  <div class="footer-inputs">
    <label>المختص: <input list="staffList" id="officer" autocomplete="off"></label>
    <label>رئيس القسم: <input list="staffList" id="head" autocomplete="off"></label>
    <label>يعتمد: <input list="staffList" id="approved" autocomplete="off"></label>
  </div>

  <div style="text-align:center; margin-top:20px;">
    <button class="add" onclick="addRow()">➕ إضافة صف</button>
    <button class="clear" onclick="clearTable()">🗑️ مسح الكل</button>
    <button class="save" onclick="saveData()">💾 حفظ البيانات</button>
    <button class="load" onclick="loadData()">📂 استرجاع البيانات</button>
    <button class="print" onclick="printPage()">🖨️ طباعة</button>
  </div>
</div>

<!-- datalists -->
<datalist id="suppliersList"></datalist>
<datalist id="itemsList"></datalist>
<datalist id="staffList"></datalist>

<script>
// Sample data - replace with your data.js
const suppliers = {
  'شركة الأدوية المصرية': { address: 'القاهرة', phone: '01234567890' },
  'شركة المستلزمات الطبية': { address: 'الإسكندرية', phone: '01987654321' },
  'مؤسسة التوريدات الصحية': { address: 'الجيزة', phone: '01122334455' }
};

const itemsDB = {
  'باراسيتامول 500': { unit: 'قرص' },
  'محقن 5 مل': { unit: 'قطعة' },
  'شاش طبي': { unit: 'لفة' },
  'قفازات طبية': { unit: 'صندوق' }
};

const staffDB = [
  'أحمد محمد علي',
  'فاطمة حسن محمود', 
  'محمد أحمد السيد',
  'نورا عبد الله إبراهيم'
];

let rowCount = 0;

// Initialize data lists
function initializeDataLists() {
  Object.keys(suppliers).forEach(name => {
    let opt = document.createElement('option');
    opt.value = name;
    document.getElementById('suppliersList').appendChild(opt);
  });

  Object.keys(itemsDB).forEach(item => {
    let opt = document.createElement('option');
    opt.value = item;
    document.getElementById('itemsList').appendChild(opt);
  });

  staffDB.forEach(staff => {
    let opt = document.createElement('option');
    opt.value = staff;
    document.getElementById('staffList').appendChild(opt);
  });
}

// Auto-fill supplier info
function fillSupplierInfo(supplierName) {
  if (suppliers[supplierName]) {
    document.getElementById('supplierAddress').value = suppliers[supplierName].address || '';
    document.getElementById('supplierPhone').value = suppliers[supplierName].phone || '';
  }
}

// Add event listener for supplier selection
document.getElementById('supplierName').addEventListener('input', function() {
  fillSupplierInfo(this.value);
});

function addRow(item='', unit='', qty=0, price=0, note='') {
  rowCount++;
  const tbody = document.querySelector("#itemsTable tbody");
  const tr = document.createElement("tr");
  const totalBeforeTax = (qty * price).toFixed(2);
  const tax = (totalBeforeTax * 0.15).toFixed(2);
  const totalAfterTax = (parseFloat(totalBeforeTax) + parseFloat(tax)).toFixed(2);

  tr.innerHTML = `
    <td>${rowCount}</td>
    <td><input list="itemsList" value="${item}" oninput="fillUnit(this)" autocomplete="off"></td>
    <td><input type="text" value="${unit}" autocomplete="off"></td>
    <td><input type="number" value="${qty}" oninput="updateRow(this)" min="0" step="0.01"></td>
    <td><input type="number" value="${price}" oninput="updateRow(this)" min="0" step="0.01"></td>
    <td class="beforeTax">${totalBeforeTax}</td>
    <td class="tax">${tax}</td>
    <td class="afterTax">${totalAfterTax}</td>
    <td><input type="text" value="${note}" autocomplete="off"></td>
    <td><button onclick="removeRow(this)" style="background:#dc3545;color:white;border:none;padding:5px 10px;border-radius:4px;cursor:pointer;">حذف</button></td>
  `;
  tbody.appendChild(tr);
  updateGrandTotal();
}

function fillUnit(input) {
  const val = input.value;
  if (itemsDB[val]) {
    input.parentElement.nextElementSibling.querySelector('input').value = itemsDB[val].unit;
  }
}

function updateRow(input) {
  const tr = input.closest('tr');
  const qty = parseFloat(tr.cells[3].querySelector('input').value) || 0;
  const price = parseFloat(tr.cells[4].querySelector('input').value) || 0;
  const beforeTax = (qty * price).toFixed(2);
  const tax = (beforeTax * 0.15).toFixed(2);
  const afterTax = (parseFloat(beforeTax) + parseFloat(tax)).toFixed(2);
  
  tr.querySelector('.beforeTax').textContent = beforeTax;
  tr.querySelector('.tax').textContent = tax;
  tr.querySelector('.afterTax').textContent = afterTax;
  updateGrandTotal();
}

function updateGrandTotal() {
  let total = 0;
  document.querySelectorAll('.afterTax').forEach(td => {
    total += parseFloat(td.textContent) || 0;
  });
  document.getElementById('grandTotal').textContent = total.toFixed(2);
}

function removeRow(btn) {
  if (confirm('هل أنت متأكد من حذف هذا الصف؟')) {
    btn.closest('tr').remove();
    renumberRows();
    updateGrandTotal();
    showAlert('تم حذف الصف بنجاح', 'success');
  }
}

function renumberRows() {
  const rows = document.querySelectorAll('#itemsTable tbody tr');
  rowCount = 0;
  rows.forEach((row, index) => {
    rowCount = index + 1;
    row.cells[0].textContent = rowCount;
  });
}

function clearTable() {
  if (confirm('هل أنت متأكد من مسح جميع البيانات؟')) {
    showLoading(true);
    setTimeout(() => {
      document.querySelector("#itemsTable tbody").innerHTML = "";
      rowCount = 0;
      updateGrandTotal();
      showLoading(false);
      showAlert('تم مسح جميع البيانات بنجاح', 'success');
    }, 500);
  }
}

// Load saved data from main form
function loadSavedDataFromMain() {
  const savedData = localStorage.getItem('mainFormData');
  if (savedData) {
    try {
      const data = JSON.parse(savedData);

      // Fill supplier information
      document.getElementById('supplierName').value = data.supplier1 || '';
      document.getElementById('orderDate').value = data.date || '';

      // Fill footer signatures
      const footerInputs = [
        document.getElementById('officer'),
        document.getElementById('head'), 
        document.getElementById('approved')
      ];
      
      if (data.footer) {
        data.footer.forEach((val, i) => {
          if (footerInputs[i]) footerInputs[i].value = val || '';
        });
      }

      // Fill table data
      if (data.table) {
        data.table.forEach(row => {
          if (row.length >= 5) {
            addRow(row[1] || '', row[2] || '', row[3] || 0, row[4] || 0, row[8] || '');
          }
        });
      }
      
      showAlert('تم تحميل البيانات من النموذج الرئيسي', 'success');
    } catch (error) {
      console.error('Error loading saved data:', error);
    }
  }
}

function addRowFromMain(row) {
  if (row && row.length >= 5) {
    addRow(row[1] || '', row[2] || '', row[3] || 0, row[4] || 0, row[8] || '');
  }
}

function saveData() {
  try {
    showLoading(true);
    
    const data = {
      supplierName: document.getElementById('supplierName').value,
      supplierAddress: document.getElementById('supplierAddress').value,
      supplierPhone: document.getElementById('supplierPhone').value,
      orderDate: document.getElementById('orderDate').value,
      taxId: document.getElementById('taxId').value,
      officer: document.getElementById('officer').value,
      head: document.getElementById('head').value,
      approved: document.getElementById('approved').value,
      table: []
    };
    
    document.querySelectorAll('#itemsTable tbody tr').forEach(tr => {
      const row = [];
      tr.querySelectorAll('input').forEach(inp => row.push(inp.value));
      data.table.push(row);
    });
    
    if (!data.supplierName.trim()) {
      showAlert('يرجى إدخال اسم المورد', 'error');
      showLoading(false);
      return;
    }
    
    const fileName = `${data.orderDate}_${data.supplierName}.json`;
    const blob = new Blob([JSON.stringify(data, null, 2)], {type: "application/json"});
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = fileName;
    link.click();
    
    showLoading(false);
    showAlert('تم حفظ البيانات بنجاح', 'success');
  } catch (error) {
    showLoading(false);
    showAlert('حدث خطأ في الحفظ: ' + error.message, 'error');
  }
}

function loadData() {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.json';
  
  input.onchange = e => {
    const file = e.target.files[0];
    if (!file) return;
    
    showLoading(true);
    const reader = new FileReader();
    
    reader.onload = ev => {
      try {
        const data = JSON.parse(ev.target.result);
        
        document.getElementById('supplierName').value = data.supplierName || '';
        document.getElementById('supplierAddress').value = data.supplierAddress || '';
        document.getElementById('supplierPhone').value = data.supplierPhone || '';
        document.getElementById('orderDate').value = data.orderDate || '';
        document.getElementById('taxId').value = data.taxId || '';
        document.getElementById('officer').value = data.officer || '';
        document.getElementById('head').value = data.head || '';
        document.getElementById('approved').value = data.approved || '';
        
        clearTableSilent();
        if (data.table) {
          data.table.forEach(row => addRow(...row));
        }
        
        showLoading(false);
        showAlert('تم تحميل البيانات بنجاح', 'success');
      } catch (error) {
        showLoading(false);
        showAlert('خطأ في قراءة الملف: ' + error.message, 'error');
      }
    };
    
    reader.readAsText(file);
  };
  
  input.click();
}

function clearTableSilent() {
  document.querySelector("#itemsTable tbody").innerHTML = "";
  rowCount = 0;
  updateGrandTotal();
}

function printPage() {
  const supplierName = document.getElementById('supplierName').value.trim();
  const tableRows = document.querySelectorAll('#itemsTable tbody tr').length;
  
  if (!supplierName || tableRows === 0) {
    showAlert('يرجى إدخال بيانات المورد والأصناف قبل الطباعة', 'error');
    return;
  }
  
  window.print();
}

function toggleMenu() {
  document.querySelector('.nav-links').classList.toggle('active');
}

function showLoading(show) {
  document.getElementById('loading').style.display = show ? 'block' : 'none';
}

function showAlert(message, type) {
  const alertId = type === 'success' ? 'alertSuccess' : 'alertError';
  const alertElement = document.getElementById(alertId);
  
  alertElement.textContent = message;
  alertElement.style.display = 'block';
  
  setTimeout(() => {
    alertElement.style.display = 'none';
  }, 4000);
}

// Set current date
function setCurrentDate() {
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('orderDate').value = today;
}

// Initialize on page load
window.onload = function() {
  initializeDataLists();
  setCurrentDate();
  loadSavedDataFromMain();
};

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
  if (e.ctrlKey || e.metaKey) {
    switch(e.key) {
      case 's':
        e.preventDefault();
        saveData();
        break;
      case 'p':
        e.preventDefault();
        printPage();
        break;
      case '=':
      case '+':
        e.preventDefault();
        addRow();
        break;
    }
  }
});

</script>

</body>
</html>